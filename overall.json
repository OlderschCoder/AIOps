{
  "__inputs": [
    {
      "name": "DS_INFLUXDB",
      "label": "InfluxDB (telegraf)",
      "description": "",
      "type": "datasource",
      "pluginId": "influxdb",
      "pluginName": "InfluxDB"
    }
  ],
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "gnetId": null,
  "graphTooltip": 0,
  "id": null,
  "iteration": 1730730000,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "table",
      "title": "Network Health Summary",
      "id": 1,
      "datasource": "${DS_INFLUXDB}",
      "pluginVersion": "10.2.0",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 0 },
      "options": {
        "showHeader": true,
        "footer": { "show": false },
        "cellHeight": "sm",
        "frameIndex": 0,
        "sortBy": []
      },
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto", "displayMode": "auto" },
          "mappings": [
            {
              "type": "value",
              "options": {
                "Red": { "index": 0, "text": "Red", "color": "red" },
                "Yellow": { "index": 1, "text": "Yellow", "color": "yellow" },
                "Green": { "index": 2, "text": "Green", "color": "green" }
              }
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 2 }
            ]
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Status" },
            "properties": [
              { "id": "custom.displayMode", "value": "color-text" }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Avg Uptime (days)" },
            "properties": [
              { "id": "unit", "value": "d" },
              { "id": "decimals", "value": 1 }
            ]
          }
        ]
      },
      "targets": [
        {
          "query": "// Flux script to build one-row-per-group summary with count, status, avg uptime\nimport \"influxdata/influxdb/schema\"\n\noption now = () => now()\n\n// Helper to compute group summary from a device set\naruba = (\n  from(bucket: \"telegraf\")\n    |> range(start: -30m)\n    |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysDescr =~ /Aruba/i)\n    |> group(columns: [\"sysName\"]) \n    |> last()\n    |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9, uptime_days: float(v: r._value) / 8640000.0 }))\n    |> map(fn: (r) => ({ r with severity: if r.age_s > 300.0 then 2.0 else if r.age_s > 120.0 then 1.0 else 0.0 }))\n    |> group()\n    |> reduce(\n      identity: {count: 0.0, max_sev: 0.0, sum_uptime_days: 0.0},\n      fn: (acc, r) => ({\n        count: acc.count + 1.0,\n        max_sev: if r.severity > acc.max_sev then r.severity else acc.max_sev,\n        sum_uptime_days: acc.sum_uptime_days + r.uptime_days\n      })\n    )\n    |> map(fn: (r) => ({ Group: \"Aruba Switches\", Count: int(v: r.count), Status: if r.max_sev >= 2.0 then \"Red\" else if r.max_sev >= 1.0 then \"Yellow\" else \"Green\", \"Avg Uptime (days)\": if r.count > 0.0 then r.sum_uptime_days / r.count else 0.0 }))\n)\n\ncisco = (\n  from(bucket: \"telegraf\")\n    |> range(start: -30m)\n    |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysDescr =~ /Cisco.*(Nexus|NX-OS)/i)\n    |> group(columns: [\"sysName\"]) \n    |> last()\n    |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9, uptime_days: float(v: r._value) / 8640000.0 }))\n    |> map(fn: (r) => ({ r with severity: if r.age_s > 300.0 then 2.0 else if r.age_s > 120.0 then 1.0 else 0.0 }))\n    |> group()\n    |> reduce(\n      identity: {count: 0.0, max_sev: 0.0, sum_uptime_days: 0.0},\n      fn: (acc, r) => ({\n        count: acc.count + 1.0,\n        max_sev: if r.severity > acc.max_sev then r.severity else acc.max_sev,\n        sum_uptime_days: acc.sum_uptime_days + r.uptime_days\n      })\n    )\n    |> map(fn: (r) => ({ Group: \"Cisco Nexus 9k\", Count: int(v: r.count), Status: if r.max_sev >= 2.0 then \"Red\" else if r.max_sev >= 1.0 then \"Yellow\" else \"Green\", \"Avg Uptime (days)\": if r.count > 0.0 then r.sum_uptime_days / r.count else 0.0 }))\n)\n\nswitch0 = (\n  from(bucket: \"telegraf\")\n    |> range(start: -30m)\n    |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysName == v.switch0_name)\n    |> group(columns: [\"sysName\"]) \n    |> last()\n    |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9, uptime_days: float(v: r._value) / 8640000.0 }))\n    |> map(fn: (r) => ({ r with severity: if r.age_s > 300.0 then 2.0 else if r.age_s > 120.0 then 1.0 else 0.0 }))\n    |> group()\n    |> reduce(\n      identity: {count: 0.0, max_sev: 0.0, sum_uptime_days: 0.0},\n      fn: (acc, r) => ({\n        count: acc.count + 1.0,\n        max_sev: if r.severity > acc.max_sev then r.severity else acc.max_sev,\n        sum_uptime_days: acc.sum_uptime_days + r.uptime_days\n      })\n    )\n    |> map(fn: (r) => ({ Group: \"Switch 0\", Count: int(v: r.count), Status: if r.max_sev >= 2.0 then \"Red\" else if r.max_sev >= 1.0 then \"Yellow\" else \"Green\", \"Avg Uptime (days)\": if r.count > 0.0 then r.sum_uptime_days / r.count else 0.0 }))\n)\n\nfw = (\n  from(bucket: \"telegraf\")\n    |> range(start: -30m)\n    |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysName =~ /FortiGate|Fortigate/i)\n    |> group(columns: [\"sysName\"]) \n    |> last()\n    |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9, uptime_days: float(v: r._value) / 8640000.0 }))\n    |> map(fn: (r) => ({ r with severity: if r.age_s > 300.0 then 2.0 else if r.age_s > 120.0 then 1.0 else 0.0 }))\n    |> group()\n    |> reduce(\n      identity: {count: 0.0, max_sev: 0.0, sum_uptime_days: 0.0},\n      fn: (acc, r) => ({\n        count: acc.count + 1.0,\n        max_sev: if r.severity > acc.max_sev then r.severity else acc.max_sev,\n        sum_uptime_days: acc.sum_uptime_days + r.uptime_days\n      })\n    )\n    |> map(fn: (r) => ({ Group: \"Firewall\", Count: int(v: r.count), Status: if r.max_sev >= 2.0 then \"Red\" else if r.max_sev >= 1.0 then \"Yellow\" else \"Green\", \"Avg Uptime (days)\": if r.count > 0.0 then r.sum_uptime_days / r.count else 0.0 }))\n)\n\nunion(tables: [aruba, cisco, switch0, fw])\n  |> keep(columns: [\"Group\",\"Count\",\"Status\",\"Avg Uptime (days)\"])\n  |> sort(columns: [\"Group\"])\n",
          "refId": "A"
        }
      ],
      "transformations": []
    },
    {
      "type": "stat",
      "title": "Aruba Status",
      "id": 2,
      "datasource": "${DS_INFLUXDB}",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 10 },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 2 } ] },
          "mappings": [
            { "type": "value", "options": { "Red": { "color": "red", "text": "Red" }, "Yellow": { "color": "yellow", "text": "Yellow" }, "Green": { "color": "green", "text": "Green" } } }
          ]
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "query": "from(bucket: \"telegraf\")\n  |> range(start: -30m)\n  |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysDescr =~ /Aruba/i)\n  |> group(columns: [\"sysName\"]) |> last()\n  |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9 }))\n  |> map(fn: (r) => ({ r with sev: if r.age_s > 300.0 then 2 else if r.age_s > 120.0 then 1 else 0 }))\n  |> group() |> max(column: \"sev\")\n  |> map(fn: (r) => ({ _value: if r.sev >= 2 then \"Red\" else if r.sev >= 1 then \"Yellow\" else \"Green\" }))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Cisco Nexus 9k Status",
      "id": 3,
      "datasource": "${DS_INFLUXDB}",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 10 },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 2 } ] },
          "mappings": [
            { "type": "value", "options": { "Red": { "color": "red", "text": "Red" }, "Yellow": { "color": "yellow", "text": "Yellow" }, "Green": { "color": "green", "text": "Green" } } }
          ]
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "query": "from(bucket: \"telegraf\")\n  |> range(start: -30m)\n  |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysDescr =~ /Cisco.*(Nexus|NX-OS)/i)\n  |> group(columns: [\"sysName\"]) |> last()\n  |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9 }))\n  |> map(fn: (r) => ({ r with sev: if r.age_s > 300.0 then 2 else if r.age_s > 120.0 then 1 else 0 }))\n  |> group() |> max(column: \"sev\")\n  |> map(fn: (r) => ({ _value: if r.sev >= 2 then \"Red\" else if r.sev >= 1 then \"Yellow\" else \"Green\" }))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Switch 0 Status",
      "id": 4,
      "datasource": "${DS_INFLUXDB}",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 10 },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 2 } ] },
          "mappings": [
            { "type": "value", "options": { "Red": { "color": "red", "text": "Red" }, "Yellow": { "color": "yellow", "text": "Yellow" }, "Green": { "color": "green", "text": "Green" } } }
          ]
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "query": "switch0_name = string(v: v.switch0_name)\nfrom(bucket: \"telegraf\")\n  |> range(start: -30m)\n  |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysName == v.switch0_name)\n  |> group(columns: [\"sysName\"]) |> last()\n  |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9 }))\n  |> map(fn: (r) => ({ r with sev: if r.age_s > 300.0 then 2 else if r.age_s > 120.0 then 1 else 0 }))\n  |> group() |> max(column: \"sev\")\n  |> map(fn: (r) => ({ _value: if r.sev >= 2 then \"Red\" else if r.sev >= 1 then \"Yellow\" else \"Green\" }))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Firewall Status",
      "id": 5,
      "datasource": "${DS_INFLUXDB}",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 10 },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "center",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "value"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 2 } ] },
          "mappings": [
            { "type": "value", "options": { "Red": { "color": "red", "text": "Red" }, "Yellow": { "color": "yellow", "text": "Yellow" }, "Green": { "color": "green", "text": "Green" } } }
          ]
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "query": "from(bucket: \"telegraf\")\n  |> range(start: -30m)\n  |> filter(fn: (r) => r._measurement == \"snmp\" and r._field == \"sysUpTime\" and exists r.sysName and r.sysName =~ /FortiGate|Fortigate/i)\n  |> group(columns: [\"sysName\"]) |> last()\n  |> map(fn: (r) => ({ r with age_s: float(v: uint(v: now()) - uint(v: r._time)) / 1e9 }))\n  |> map(fn: (r) => ({ r with sev: if r.age_s > 300.0 then 2 else if r.age_s > 120.0 then 1 else 0 }))\n  |> group() |> max(column: \"sev\")\n  |> map(fn: (r) => ({ _value: if r.sev >= 2 then \"Red\" else if r.sev >= 1 then \"Yellow\" else \"Green\" }))"
        }
      ]
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["Network Health", "SNMP", "SCCC"],
  "templating": {
    "list": [
      {
        "name": "switch0_name",
        "type": "textbox",
        "label": "Switch 0 sysName",
        "query": "",
        "current": { "selected": true, "text": "Core-0", "value": "Core-0" },
        "hide": 0
      }
    ]
  },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "",
  "title": "High-Level Network Health",
  "uid": "net-health-summary",
  "version": 1,
  "weekStart": ""
}
